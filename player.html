<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Player</title>

    <!-- Prevent caching and inspection -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Basic security headers for mobile -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">

    <!-- Prevent mobile sniffers -->
    <meta name="format-detection" content="telephone=no">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, nocache">

    <!-- Mobile and desktop compatibility -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100svh; /* Support for small viewport units */
            overflow: hidden;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: 100svh;
            }

            .controls {
                padding: 0.5rem;
                gap: 0.5rem;
                flex-direction: column;
            }

            .left-controls,
            .right-controls {
                width: 100%;
                justify-content: center;
                gap: 0.5rem;
            }

            .control-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                min-height: 36px;
            }

            .provider-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
                min-height: 40px;
                border-radius: 20px;
            }

            .loading {
                padding: 1rem;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
            }

            .loading-progress {
                max-width: 250px;
            }
        }

        /* Desktop-specific styles */
        @media (min-width: 769px) {
            .controls {
                padding: 1rem 2rem;
                gap: 1rem;
            }

            .provider-btn {
                padding: 0.6rem 1.2rem;
                font-size: 1rem;
                min-height: 44px;
            }

            .loading {
                padding: 2rem;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .controls {
                padding: 0.3rem;
                justify-content: center;
            }

            .provider-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
                min-height: 36px;
            }
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #00FF9D;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-progress {
            margin-top: 1rem;
            width: 100%;
            max-width: 300px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00FF9D, #00cc7a);
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease;
            animation: progress-pulse 2s ease-in-out infinite;
        }

        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: #ff6b6b;
            text-align: center;
            padding: 2rem;
            flex-direction: column;
            gap: 1rem;
        }

        .player-container {
            flex-grow: 1;
            background-color: #000;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .controls {
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .left-controls,
        .right-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: #00FF9D;
            color: #000;
            border-color: #00FF9D;
            transform: translateY(-2px);
        }

        .control-btn i {
            font-size: 0.8rem;
        }

        .provider-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .provider-btn:hover,
        .provider-btn.active {
            background: #00FF9D;
            color: #000;
            border-color: #00FF9D;
        }

        .retry-btn {
            background: #ff6b6b;
            color: #fff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        .retry-btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .dev-tools-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .warning-content {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            padding: 2rem 3rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .warning-content h2 {
            color: white;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .warning-content p {
            color: #ffcccc;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .sniffer-warning, .extension-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .instructions {
            margin: 1rem 0;
            text-align: left;
        }

        .instructions h3 {
            color: #fff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .instructions h4 {
            color: #00FF9D;
            margin: 1.5rem 0 1rem 0;
            font-size: 1.1rem;
        }

        .instructions h5 {
            color: #ccc;
            margin: 1rem 0 0.5rem 0;
            font-size: 1rem;
        }

        .browser-guide {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #00FF9D;
        }

        .browser-guide ol {
            margin-left: 1rem;
        }

        .browser-guide li {
            margin: 0.3rem 0;
            color: #ddd;
            line-height: 1.4;
        }

        .troubleshooting {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 0, 0.1);
            border-radius: 8px;
            border-left: 3px solid #ffeb3b;
        }

        .troubleshooting h5 {
            color: #ffeb3b;
            margin-bottom: 0.5rem;
        }

        .troubleshooting ul {
            margin-left: 1rem;
        }

        .troubleshooting li {
            margin: 0.3rem 0;
            color: #ddd;
        }

        .warning-content {
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .warning-content::-webkit-scrollbar {
            width: 8px;
        }

        .warning-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .warning-content::-webkit-scrollbar-thumb {
            background: #00FF9D;
            border-radius: 10px;
        }

        /* Hide common ad elements */
        .ad-banner,
        .popup-ad,
        .advertisement,
        #ad-container,
        [class*="ad-"],
        [id*="ad-"],
        [class*="popup"],
        [id*="popup"],
        .overlay-ad,
        .video-overlay,
        iframe[src*="ads"],
        div[style*="position: fixed"][style*="z-index: 999"],
        div[style*="position: absolute"][style*="top: 0"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Block ad overlays */
        body.ad-overlay-active::before {
            display: none !important;
        }

        /* Hide floating ads */
        .floating-ad,
        .sticky-ad,
        .bottom-ad,
        .top-ad {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p id="loadingText">Loading movie player...</p>
        <div class="loading-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Initializing...</p>
        </div>
    </div>

    <div id="error" class="error" style="display: none;">
        <h3>⚠️ Error Loading Movie</h3>
        <p>Could not load the movie player. Please try again.</p>
        <button id="retryBtn" class="retry-btn">Retry</button>
    </div>

    <!-- Developer Tools Warning Overlay -->
    <div id="devToolsWarning" class="dev-tools-warning" style="display: none;">
        <div class="warning-content">
            <h2>⚠️ Developer Tools Detected!</h2>
            <p>Please close developer tools to continue watching.</p>
            <p style="font-size: 14px; opacity: 0.8; margin-top: 10px;">
                Refresh the page after closing developer tools.
            </p>
            <button onclick="location.reload()" class="retry-btn">Refresh Page</button>
        </div>
    </div>

    <div id="playerContainer" class="player-container" style="display: none;">
        <div class="controls">
            <div class="left-controls">
                <span id="movieTitle">Loading...</span>
            </div>
            <div class="right-controls">
                <button id="refreshBtn" class="control-btn" title="Refresh Player">
                    <i class="fas fa-redo"></i> Refresh
                </button>
                <div id="providerButtons"></div>
            </div>
        </div>
        <iframe id="moviePlayer" allowfullscreen allow="autoplay" style="border: none; width: 100%; height: 100%; visibility: hidden;"></iframe>
    </div>

    <script>
        // Domain validation - protect against direct access
        (function() {
          // ⚙️ CONFIGURATION: Your EXACT allowed domains
          const allowedDomains = [
            'streamflix-use.vercel.app',    // Your Vercel deployment
            'empuertos.github.io'          // Your GitHub Pages
          ];

          // Additional allowed patterns
          const allowedPatterns = [
            /^localhost$/,
            /^127\.0\.0\.1$/,
            /^.*\.vercel\.app$/,           // Any Vercel subdomain
            /^.*\.github\.io$/            // Any GitHub Pages
          ];

          const currentDomain = window.location.hostname.toLowerCase();

          // Check exact domain match
          let isAllowed = allowedDomains.includes(currentDomain);

          // Check pattern match
          if (!isAllowed) {
            isAllowed = allowedPatterns.some(pattern => pattern.test(currentDomain));
          }

          console.log('Domain validation check:', {
            currentDomain,
            allowedDomains,
            isAllowed
          });

          if (!isAllowed) {
            document.body.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #000; color: #ff6b6b; font-family: Arial, sans-serif;">
                <div style="text-align: center; padding: 2rem; border-radius: 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 107, 107, 0.3);">
                  <h1>🚫 Access Denied</h1>
                  <p>This content can only be accessed from:</p>
                  <p style="color: #00FF9D; font-size: 0.9rem; margin: 0.5rem 0;">• https://streamflix-use.vercel.app/</p>
                  <p style="color: #00FF9D; font-size: 0.9rem; margin: 0.5rem 0;">• https://empuertos.github.io/movielist/</p>
                  <p style="color: #ccc; font-size: 0.8rem;">Current unauthorized domain: ${currentDomain}</p>
                </div>
              </div>
            `;
            throw new Error('Access denied: Invalid domain');
          }

          // Additional referrer validation
          const referrer = document.referrer;
          if (referrer) {
            const referrerUrl = new URL(referrer);
            const referrerDomain = referrerUrl.hostname.toLowerCase();
            const isValidReferrer = allowedDomains.some(domain => referrerDomain === domain || referrerDomain.endsWith('.' + domain));

            if (!isValidReferrer) {
              console.warn('Invalid referrer domain:', referrerDomain);
              // You could add additional checks here
            }
          }

          console.log('Domain validation passed for:', currentDomain);
        })();

        // Additional protection against embedding in unauthorized sites
        (function() {
          try {
            // Check if we're in an iframe
            if (window.self !== window.top) {
              const parentDomain = document.referrer ? new URL(document.referrer).hostname : 'unknown';
              const allowedParentDomains = ['localhost', '127.0.0.1', 'yourdomain.com', 'www.yourdomain.com'];

              const isValidParent = allowedParentDomains.some(domain =>
                parentDomain === domain || parentDomain.endsWith('.' + domain)
              );

              if (!isValidParent) {
                console.warn('Unauthorized embedding detected from:', parentDomain);
                // You could add additional checks here
              }
            }
          } catch (error) {
            console.warn('Cannot check parent window:', error);
          }
        })();

        // Get movie parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        const mode = urlParams.get('mode') || 'movie';
        const season = urlParams.get('season') || '1';
        const episode = urlParams.get('episode') || '1';

        const moviePlayer = document.getElementById('moviePlayer');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const playerContainer = document.getElementById('playerContainer');
        const movieTitle = document.getElementById('movieTitle');
        const providerButtonsContainer = document.getElementById('providerButtons');
        const retryBtn = document.getElementById('retryBtn');
        const refreshBtn = document.getElementById('refreshBtn');

        let currentProvider = 'vidora.su'; // Default provider

        // List of available providers
        const providers = {
            'vidora.su': 'Alpha',
            'autoembed.pro': 'Bravo',
            'vidrock.net': 'Charlie',
            '111movies': 'Delta',
            'vidsrc': 'Echo',
            'vidsrc.to': 'Foxtrot',
            'moviemaze.cc': 'Golf',
            'vidlink': 'Hotel',
            'vixsrc.to': 'India'
        };

        function generateStreamUrl(provider, id, mode, season, episode) {
            if (mode === 'movie') {
                switch (provider) {
                    case 'vidsrc': return `https://vidsrc.cc/v2/embed/movie/${id}`;
                    case 'vidsrc.to': return `https://vidsrc.to/embed/movie/${id}`;
                    case 'autoembed.pro': return `https://autoembed.pro/embed/movie/${id}`;
                    case '111movies': return `https://111movies.com/movie/${id}`;
                    case 'moviemaze.cc': return `https://moviemaze.cc/watch/movie/${id}`;
                    case 'vidora.su': return `https://vidora.su/movie/${id}`;
                    case 'vidlink': return `https://vidlink.pro/movie/${id}`;
                    case 'vidrock.net': return `https://vidrock.net/movie/${id}`;
                    case 'vixsrc.to': return `https://vixsrc.to/movie/${id}/`;
                    default: return `https://vidsrc.cc/v2/embed/movie/${id}`;
                }
            } else { // tv
                switch (provider) {
                    case 'vidsrc': return `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`;
                    case 'vidsrc.to': return `https://vidsrc.to/embed/tv/${id}/${season}/${episode}`;
                    case 'autoembed.pro': return `https://autoembed.pro/embed/tv/${id}?season=${season}&episode=${episode}`;
                    case '111movies': return `https://111movies.com/tv/${id}/${season}/${episode}`;
                    case 'moviemaze.cc': return `https://moviemaze.cc/watch/tv/${id}?ep=${episode}&season=${season}`;
                    case 'vidora.su': return `https://vidora.su/tv/${id}/${season}/${episode}`;
                    case 'vidlink': return `https://vidlink.pro/tv/${id}/${season}/${episode}`;
                    case 'vidrock.net': return `https://vidrock.net/tv/${id}/${season}/${episode}`;
                    case 'vixsrc.to': return `https://vixsrc.to/tv/${id}/${season}/${episode}/`;
                    default: return `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`;
                }
            }
        }

        async function loadMovie(provider = currentProvider) {
            if (!movieId) {
                showError();
                return;
            }

            try {
                loadingDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                playerContainer.style.display = 'none';

                // Fetch movie/TV show details to get the title
                await fetchMovieDetails();

                const streamUrl = generateStreamUrl(provider, movieId, mode, season, episode);

                // Set iframe src - simplified approach
                setTimeout(() => {
                    try {
                        console.log('Setting iframe src...');
                        moviePlayer.src = streamUrl;
                        moviePlayer.style.visibility = 'visible';

                        // Simple timeout to show player
                        setTimeout(() => {
                            console.log('Timeout reached, showing player');
                            loadingDiv.style.display = 'none';
                            playerContainer.style.display = 'block';
                        }, 3000);

                    } catch (error) {
                        console.error('Error setting iframe src:', error);
                        showError();
                    }
                }, 500);

            } catch (error) {
                console.error('Error loading movie:', error);
                showError();
            }
        }

        async function fetchMovieDetails() {
            try {
                // Use the same API endpoint as the main app
                const apiUrl = window.location.origin;
                const endpoint = mode === 'movie'
                    ? `${apiUrl}/${mode}/${movieId}`
                    : `${apiUrl}/${mode}/${movieId}`;

                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const title = mode === 'movie' ? data.title : data.name;
                    const year = mode === 'movie'
                        ? (data.release_date ? data.release_date.substring(0, 4) : '')
                        : (data.first_air_date ? data.first_air_date.substring(0, 4) : '');

                    if (mode === 'movie') {
                        movieTitle.textContent = `${title}${year ? ` (${year})` : ''}`;
                    } else {
                        movieTitle.textContent = `${title}${year ? ` (${year})` : ''} - S${season}E${episode}`;
                    }
                } else {
                    console.warn('Movie details API failed:', response.status);
                    // Fallback to ID if API fails
                    if (mode === 'movie') {
                        movieTitle.textContent = `Movie: ${movieId}`;
                    } else {
                        movieTitle.textContent = `TV Show: ${movieId} - S${season}E${episode}`;
                    }
                }
            } catch (error) {
                console.error('Error fetching movie details:', error);
                // Fallback to ID if API fails
                if (mode === 'movie') {
                    movieTitle.textContent = `Movie: ${movieId}`;
                } else {
                    movieTitle.textContent = `TV Show: ${movieId} - S${season}E${episode}`;
                }
            }
        }

        function showError() {
            loadingDiv.style.display = 'none';
            playerContainer.style.display = 'none';
            errorDiv.style.display = 'block';

            // Update error message with more details
            const errorTitle = errorDiv.querySelector('h3');
            const errorMessage = errorDiv.querySelector('p');

            if (movieId) {
                errorTitle.textContent = '⚠️ Error Loading Movie';
                errorMessage.textContent = `Could not load movie (ID: ${movieId}). Please try again or try a different streaming provider.`;
            } else {
                errorTitle.textContent = '⚠️ Invalid Movie';
                errorMessage.textContent = 'No movie selected. Please go back and select a movie to watch.';
            }
        }

        function setupProviderButtons() {
            providerButtonsContainer.innerHTML = Object.entries(providers)
                .map(([value, name]) =>
                    `<button class="provider-btn ${value === currentProvider ? 'active' : ''}" data-provider="${value}">${name}</button>`
                ).join('');

            providerButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('provider-btn')) {
                    document.querySelectorAll('.provider-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentProvider = e.target.dataset.provider;
                    loadMovie(currentProvider);
                }
            });
        }

        // Auto-retry with different provider if loading fails
        function autoRetryWithDifferentProvider() {
            const providerKeys = Object.keys(providers);
            const currentIndex = providerKeys.indexOf(currentProvider);

            if (currentIndex < providerKeys.length - 1) {
                // Try next provider
                currentProvider = providerKeys[currentIndex + 1];
                console.log('Retrying with provider:', currentProvider);

                // Update active button
                document.querySelectorAll('.provider-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-provider="${currentProvider}"]`).classList.add('active');

                loadMovie(currentProvider);
            } else {
                // All providers failed
                showError();
            }
        }

        // Enhanced error handling with auto-retry
        let retryCount = 0;
        const maxRetries = 2;

        function showError() {
            loadingDiv.style.display = 'none';
            playerContainer.style.display = 'none';
            errorDiv.style.display = 'block';

            // Update error message with more details
            const errorTitle = errorDiv.querySelector('h3');
            const errorMessage = errorDiv.querySelector('p');

            if (movieId) {
                errorTitle.textContent = '⚠️ Error Loading Movie';
                errorMessage.textContent = `Could not load movie (ID: ${movieId}) with ${currentProvider}. ${retryCount < maxRetries ? 'Trying different provider...' : 'Please try again later or use a different movie.'}`;
            } else {
                errorTitle.textContent = '⚠️ Invalid Movie';
                errorMessage.textContent = 'No movie selected. Please go back and select a movie to watch.';
            }
        }

        // Refresh functionality
        function refreshPlayer() {
            console.log('Refreshing player...');

            // Show loading state
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            playerContainer.style.display = 'none';

            // Reset retry count
            retryCount = 0;

            // Reload the movie with current provider
            setTimeout(() => {
                loadMovie(currentProvider);
            }, 500);
        }

        // Initialize player
        document.addEventListener('DOMContentLoaded', () => {
            setupProviderButtons();

            // Retry button (for errors)
            retryBtn.addEventListener('click', () => {
                retryCount = 0;
                loadMovie(currentProvider);
            });

            // Refresh button (manual refresh)
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshPlayer);
            }

            // Enhanced error handling with auto-retry
            moviePlayer.addEventListener('error', () => {
                if (retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(() => {
                        autoRetryWithDifferentProvider();
                    }, 1000);
                } else {
                    showError();
                }
            });

            loadMovie();
        });

        // Handle iframe load errors
        moviePlayer.addEventListener('error', () => {
            console.error('Iframe failed to load');
            showError();
        });

        // Monitor iframe loading
        let loadTimeout;
        moviePlayer.addEventListener('load', () => {
            clearTimeout(loadTimeout);
            console.log('Iframe loaded successfully');
        });

        // Enhanced error detection
        function checkIframeHealth() {
            try {
                if (moviePlayer.contentWindow && moviePlayer.contentWindow.location) {
                    const iframeUrl = moviePlayer.contentWindow.location.href;
                    if (iframeUrl === 'about:blank' || iframeUrl === '') {
                        console.warn('Iframe URL is blank');
                        setTimeout(() => {
                            if (moviePlayer.contentWindow.location.href === 'about:blank') {
                                showError();
                            }
                        }, 2000);
                    }
                }
            } catch (error) {
                // Cross-origin error is expected, but if we get here, something is wrong
                console.warn('Cannot access iframe content:', error);
            }
        }

        // Check iframe health periodically
        setInterval(checkIframeHealth, 5000);

        // Basic security and ad blocking
        function basicSecurity() {
            // Disable right-click context menu on iframe only
            moviePlayer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
        }

        // Ad blocking and popup prevention
        function blockAdsAndPopups() {
            // Block window.open to prevent popup ads
            const originalWindowOpen = window.open;
            window.open = function(url, name, specs) {
                // Allow legitimate popups (small windows for player controls)
                if (name && (name.includes('player') || name.includes('video') || name === '_blank')) {
                    return originalWindowOpen.apply(this, arguments);
                }

                // Block suspicious popups
                if (url && (url.includes('ads') || url.includes('popup') || url.includes('click'))) {
                    console.log('Blocked popup:', url);
                    return null;
                }

                // Block popups without URL (common ad technique)
                if (!url || url === 'about:blank') {
                    console.log('Blocked blank popup');
                    return null;
                }

                return originalWindowOpen.apply(this, arguments);
            };

            // Monitor for ad overlays and remove them
            function removeAdOverlays() {
                // Common ad overlay selectors
                const adSelectors = [
                    '[class*="ad"]',
                    '[id*="ad"]',
                    '[class*="popup"]',
                    '[id*="popup"]',
                    '[class*="overlay"]',
                    '[id*="overlay"]',
                    '.ad-banner',
                    '.popup-ad',
                    '#ad-container',
                    '.advertisement',
                    '[data-ad]',
                    'iframe[src*="ads"]',
                    'div[style*="position: fixed"][style*="z-index: 999"]',
                    'div[style*="position: absolute"][style*="top: 0"]'
                ];

                adSelectors.forEach(selector => {
                    const ads = document.querySelectorAll(selector);
                    ads.forEach(ad => {
                        if (ad && ad.parentNode) {
                            console.log('Removed ad element:', selector);
                            ad.remove();
                        }
                    });
                });
            }

            // Use MutationObserver to detect and remove new ad elements
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check if the new element looks like an ad
                            const element = node;
                            const className = element.className || '';
                            const id = element.id || '';
                            const style = element.getAttribute('style') || '';

                            if (
                                className.toLowerCase().includes('ad') ||
                                id.toLowerCase().includes('ad') ||
                                className.toLowerCase().includes('popup') ||
                                id.toLowerCase().includes('popup') ||
                                style.includes('position: fixed') && style.includes('z-index')
                            ) {
                                console.log('Removed dynamic ad element');
                                element.remove();
                            }
                        }
                    });
                });
            });

            // Start observing DOM changes
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            // Periodic ad cleanup
            setInterval(removeAdOverlays, 2000);

            // Block common ad scripts
            const originalCreateElement = document.createElement;
            document.createElement = function(tagName, options) {
                const element = originalCreateElement.call(this, tagName, options);

                // Monitor script creation for ad scripts
                if (tagName.toLowerCase() === 'script') {
                    const originalSrc = element.src;
                    Object.defineProperty(element, 'src', {
                        set: function(value) {
                            if (value && (value.includes('ads') || value.includes('analytics') || value.includes('tracker'))) {
                                console.log('Blocked ad script:', value);
                                return; // Block the script
                            }
                            originalSrc = value;
                        },
                        get: function() {
                            return originalSrc;
                        }
                    });
                }

                return element;
            };

            // Override alert and confirm to block ad dialogs
            const originalAlert = window.alert;
            const originalConfirm = window.confirm;

            window.alert = function(message) {
                if (message && (message.toLowerCase().includes('ad') || message.toLowerCase().includes('subscription'))) {
                    console.log('Blocked ad alert:', message);
                    return;
                }
                return originalAlert.apply(this, arguments);
            };

            window.confirm = function(message) {
                if (message && (message.toLowerCase().includes('ad') || message.toLowerCase().includes('subscription'))) {
                    console.log('Blocked ad confirm:', message);
                    return false; // Block the dialog
                }
                return originalConfirm.apply(this, arguments);
            };
        }

        // Initialize security and ad blocking after player loads
        setTimeout(() => {
            basicSecurity();
            blockAdsAndPopups();
        }, 2000);

        // Disable developer tools and right-click
        function disableDevTools() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable text selection
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable copy functionality
            document.addEventListener('copy', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable cut functionality
            document.addEventListener('cut', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable paste functionality
            document.addEventListener('paste', function(e) {
                e.preventDefault();
                return false;
            });

            // Disable F12 (Developer Tools)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+Shift+I (Inspect Element)
                if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+Shift+C (Inspect Element alternative)
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+U (View Page Source)
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+Shift+J (Console)
                if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+Shift+K (Console alternative)
                if (e.ctrlKey && e.shiftKey && e.key === 'K') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+A (Select All)
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+S (Save Page)
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    return false;
                }

                // Disable Ctrl+P (Print)
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    return false;
                }
            });

            // Disable drag and drop
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });

            document.addEventListener('drop', function(e) {
                e.preventDefault();
                return false;
            });

            // Override console methods to prevent access
            let devtools = {open: false};
            let threshold = 160;

            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        showDevToolsWarning();
                    }
                } else {
                    if (devtools.open) {
                        devtools.open = false;
                        hideDevToolsWarning();
                    }
                }
            }, 1000);

            // Disable window resize to prevent dev tools detection bypass
            window.addEventListener('resize', function() {
                if (window.outerHeight - window.innerHeight > threshold || window.outerWidth - window.innerWidth > threshold) {
                    showDevToolsWarning();
                }
            });

            function showDevToolsWarning() {
                document.getElementById('devToolsWarning').style.display = 'flex';
                // Pause video if playing
                if (moviePlayer && moviePlayer.contentWindow) {
                    try {
                        moviePlayer.contentWindow.postMessage('pause', '*');
                    } catch (e) {
                        // Ignore errors
                    }
                }
            }

            function hideDevToolsWarning() {
                document.getElementById('devToolsWarning').style.display = 'none';
                // Resume video if needed
                if (moviePlayer && moviePlayer.contentWindow) {
                    try {
                        moviePlayer.contentWindow.postMessage('play', '*');
                    } catch (e) {
                        // Ignore errors
                    }
                }
            }
        }

        // Initialize all protections
        setTimeout(disableDevTools, 1000);

        // Mobile and desktop specific enhancements
        function enhancePlatformExperience() {
            const isMobile = /android|iphone|ipad|ipod|blackberry|windows phone/i.test(navigator.userAgent.toLowerCase());
            const isDesktop = !isMobile;

            if (isMobile) {
                // Mobile-specific enhancements
                console.log('Mobile device detected - applying mobile optimizations');

                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // Improve touch responsiveness
                document.addEventListener('touchstart', () => {}, { passive: true });
                document.addEventListener('touchmove', () => {}, { passive: true });

                // Hide mobile browser UI for better fullscreen experience
                if (window.navigator.standalone !== true) {
                    // Not in PWA mode, optimize for mobile browser
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                    }, 100);
                }

            } else if (isDesktop) {
                // Desktop-specific enhancements
                console.log('Desktop device detected - applying desktop optimizations');

                // Enable keyboard shortcuts for desktop
                document.addEventListener('keydown', (e) => {
                    // Space bar to pause/play (if video player supports it)
                    if (e.code === 'Space' && moviePlayer.contentWindow) {
                        try {
                            moviePlayer.contentWindow.postMessage('toggle-play', '*');
                        } catch (error) {
                            // Ignore if video doesn't support it
                        }
                    }

                    // F key for fullscreen
                    if (e.key === 'f' || e.key === 'F') {
                        if (moviePlayer.requestFullscreen) {
                            moviePlayer.requestFullscreen();
                        }
                    }

                    // M key for mute/unmute
                    if (e.key === 'm' || e.key === 'M') {
                        try {
                            moviePlayer.contentWindow.postMessage('toggle-mute', '*');
                        } catch (error) {
                            // Ignore if video doesn't support it
                        }
                    }
                });

                // Enable mouse wheel volume control (if supported)
                moviePlayer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    try {
                        const delta = e.deltaY > 0 ? 'volume-down' : 'volume-up';
                        moviePlayer.contentWindow.postMessage(delta, '*');
                    } catch (error) {
                        // Ignore if video doesn't support it
                    }
                });
            }

            // Universal enhancements for both platforms
            console.log('Applying universal enhancements');

            // Improve loading experience
            const loadingText = document.getElementById('loadingText');
            const progressText = document.getElementById('progressText');

            if (loadingText && progressText) {
                const loadingSteps = [
                    'Initializing player...',
                    'Connecting to stream...',
                    'Loading video content...',
                    'Starting playback...'
                ];

                let stepIndex = 0;
                const loadingInterval = setInterval(() => {
                    if (stepIndex < loadingSteps.length) {
                        progressText.textContent = loadingSteps[stepIndex];
                        stepIndex++;
                    } else {
                        clearInterval(loadingInterval);
                    }
                }, 800);
            }
        }

        // Initialize platform-specific enhancements
        setTimeout(enhancePlatformExperience, 1500);

        // Mobile HTTP sniffer detection and blocking
        function detectMobileSniffers() {
            // Detect common proxy/sniffer apps by checking for suspicious patterns
            const userAgent = navigator.userAgent.toLowerCase();
            const suspiciousApps = [
                'charles', 'fiddler', 'burp', 'mitmproxy', 'wireshark',
                'httpcanary', 'packetcapture', 'proxifier', 'postern',
                'shadowrocket', 'quantumult', 'surge', 'loon',
                'http injector', 'kpn tunnel', 'psiphon', 'orbot',
                'netguard', 'adguard', 'dns66', 'blokada'
            ];

            for (let app of suspiciousApps) {
                if (userAgent.includes(app)) {
                    showSnifferWarning(app);
                    return true;
                }
            }

            // Check for VPN/proxy indicators
            if (window.location.hostname !== 'streamflix.22afed28-f0b2-46d0-8804-c90e25c90bd4.workers.dev') {
                showSnifferWarning('proxy/vpn');
                return true;
            }

            // Check for certificate pinning bypass attempts
            if (window.location.protocol !== 'https:') {
                showSnifferWarning('insecure connection');
                return true;
            }

            // Monitor network requests for interception attempts
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                // Log suspicious fetch attempts (for debugging)
                if (args[0] && typeof args[0] === 'string' && args[0].includes('autoembed.pro')) {
                    console.warn('Network request intercepted:', args[0]);
                }
                return originalFetch.apply(this, args);
            };

            // Monitor XMLHttpRequest
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url) {
                if (url && url.includes('autoembed.pro')) {
                    console.warn('XHR request intercepted:', url);
                }
                return originalOpen.apply(this, arguments);
            };

            return false;
        }

        function showSnifferWarning(detectedApp) {
            // Hide all other content and show warning
            document.querySelectorAll('div').forEach(div => {
                if (!div.id || (div.id !== 'snifferWarning' && div.id !== 'devToolsWarning')) {
                    div.style.display = 'none';
                }
            });

            // Create sniffer warning if it doesn't exist
            if (!document.getElementById('snifferWarning')) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'snifferWarning';
                warningDiv.className = 'sniffer-warning';
                warningDiv.innerHTML = `
                    <div class="warning-content">
                        <h2>🚫 Network Inspection Detected!</h2>
                        <p>HTTP sniffer or proxy app detected: <strong>${detectedApp}</strong></p>
                        <p>Please disable network inspection tools to continue watching.</p>
                        <p style="font-size: 14px; opacity: 0.8; margin-top: 10px;">
                            Close ${detectedApp} and refresh the page.
                        </p>
                        <button onclick="location.reload()" class="retry-btn">Refresh Page</button>
                    </div>
                `;
                document.body.appendChild(warningDiv);
            }

            document.getElementById('snifferWarning').style.display = 'flex';
        }

        // Initialize mobile sniffer detection
        setTimeout(detectMobileSniffers, 1500);

        // Periodic check for mobile sniffers
        setInterval(detectMobileSniffers, 5000);

        // Extension detection disabled - allowing all extensions
        function detectBrowserExtensions() {
            // Extension detection is disabled
            console.log('Extension detection is disabled');
            return false;
        }

        function showExtensionWarning(extensionName) {
            // Extension warnings are disabled
            console.log('Extension warning disabled for:', extensionName);
        }

        // Store original API references for comparison
        const originalFetch = window.fetch;
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalConsole = window.console;

        // Extension detection is disabled
        console.log('Extension detection is disabled - no periodic checks');
    </script>
</body>
</html>
