<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movies</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #141414;
      color: #fff;
    }
    header {
      background: #000;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      color: #e50914;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .video-wrapper {
      width: 90%;
      max-width: 1000px;
      margin-bottom: 20px;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: none;
      border-radius: 8px;
    }
    .movie-info {
      text-align: center;
      margin-top: 15px;
    }
    .movie-info img {
      margin-top: 10px;
      border-radius: 8px;
      max-width: 200px;
    }

    /* Search bar */
    .search-box {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
      position: relative;
    }
    .search-box input {
      padding: 12px 15px;
      border-radius: 25px;
      border: 2px solid #333;
      background: #222;
      color: #fff;
      font-size: 16px;
      width: 300px;
      outline: none;
      transition: border-color 0.3s;
    }
    .search-box input:focus {
      border-color: #e50914;
    }
    .search-box select {
      padding: 12px;
      border-radius: 25px;
      border: 2px solid #333;
      background: #222;
      color: #fff;
      font-size: 16px;
      outline: none;
      cursor: pointer;
    }
    .search-box button {
      padding: 12px 20px;
      background: #e50914;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    .search-box button:hover {
      background: #b20710;
    }
    /* Episode selector */
    .episodes {
      margin: 20px;
      text-align: center;
    }
    .episodes select {
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
    }
    /* Search results */
    .search-results {
      width: 90%;
      max-width: 1000px;
      background: #222;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-result-item:hover {
      background: #333;
    }
    .search-result-item img {
      width: 50px;
      border-radius: 5px;
    }
    .search-result-item .info {
      flex: 1;
    }
    .search-result-item .title {
      font-weight: bold;
    }
    .search-result-item .year {
      font-size: 12px;
      color: #ccc;
    }
  </style>
</head>
<body>

  <header>üé¨ Movies</header>

  <div class="container">
    <!-- Search Bar -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search movies or enter IMDb ID...">
      <select id="providerSelect">
      </select>
      <button onclick="searchMovie()">üîç Search</button>
    </div>

    <!-- Search Results -->
    <div class="search-results" id="searchResults"></div>

    <!-- Video Player -->
    <div class="video-wrapper">
      <iframe id="videoFrame" src="" allowfullscreen></iframe>
    </div>

    <!-- Movie Info -->
    <div class="movie-info" id="movieInfo"></div>




  </div>

  <script src="config.js"></script>
  <script>
    const frame = document.getElementById("videoFrame");
    const movieInfo = document.getElementById("movieInfo");
    let currentImdb = null;

    // Load details + play via IMDb ID
    async function loadDetails(imdbid) {
      currentImdb = imdbid;

      const detailsURL = `http://www.omdbapi.com/?apikey=${OMDB_KEY}&i=${imdbid}`;
      const detailsRes = await fetch(detailsURL);
      const details = await detailsRes.json();

      if (details.Response === "True") {
        playContent(imdbid);
      } else {
        frame.src = "";
        alert("Movie not found!");
        return;
      }

      movieInfo.innerHTML = `
        <h2>${details.Title} (${details.Year})</h2>
        <p><strong>Genre:</strong> ${details.Genre}</p>
        <p><strong>Plot:</strong> ${details.Plot}</p>
        <p><strong>Director:</strong> ${details.Director}</p>
        <p><strong>Actors:</strong> ${details.Actors}</p>
        <img src="${details.Poster !== "N/A" ? details.Poster : ''}" alt="Poster">
      `;
    }

    // Play content
    const providerSelect = document.getElementById("providerSelect");
    providers.forEach(p => {
      let opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      providerSelect.appendChild(opt);
    });
    // Prefer vidrock.net as default
    if (providers.includes("vidrock.net")) {
      providerSelect.value = "vidrock.net";
    }

    function getEmbed(imdb, p){
      let base = "";
      switch(p){
        case "vidsrc.me": base = `https://vidsrc.me/embed/${imdb}`; break;
        case "vidsrc.cc": base = `https://vidsrc.cc/v2/embed/${imdb}`; break;
        case "vidsrc.vip": base = `https://vidsrc.vip/embed/${imdb}`; break;
        case "vidlink.pro": base = `https://vidlink.pro/movie/${imdb}`; break;
        case "vidrock.net": base = `https://vidrock.net/embed/movie/${imdb}`; break;
        case "kisskh.co": base = `https://kisskh.co/embed/${imdb}`; break;
        case "filmxy.online": base = `https://filmxy.online/embed/${imdb}`; break;
        case "smashystream": base = `https://smashystream.com/embed/${imdb}`; break;
        case "vidfast.pro": base = `https://vidfast.pro/embed/${imdb}`; break;
        case "fmovies.gd": base = `https://fmovies.gd/embed/${imdb}`; break;
        default: base = `https://vidsrc.me/embed/${imdb}`;
      }
      return base;
    }

    function testProvider(url) {
      return new Promise((resolve, reject) => {
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.style.display = "none";
        iframe.onload = () => resolve(true);
        iframe.onerror = () => reject(false);
        document.body.appendChild(iframe);
        setTimeout(() => reject(false), 10000); // 10s timeout
      });
    }

    async function autoSelectProvider(imdb) {
      const selectedProvider = providerSelect.value;
      // First, try the user-selected provider
      if (selectedProvider) {
        const url = getEmbed(imdb, selectedProvider);
        try {
          await testProvider(url);
          return url;
        } catch (e) {
          console.log(`Selected provider ${selectedProvider} failed, trying others...`);
        }
      }

      // If selected fails or none selected, try others
      for (let p of providers) {
        if (p === selectedProvider) continue; // Skip if already tried
        const url = getEmbed(imdb, p);
        try {
          await testProvider(url);
          providerSelect.value = p;
          return url;
        } catch (e) {
          console.log(`Provider failed: ${p}`);
        }
      }
      return getEmbed(imdb, "vidsrc.me");
    }

    async function playContent(imdb) {
      let url = await autoSelectProvider(imdb);
      frame.src = url;
    }

    // Debounce function
    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // Fetch suggestions
    async function fetchSuggestions(query) {
      const searchResultsDiv = document.getElementById("searchResults");
      searchResultsDiv.innerHTML = "";

      if (!query.trim()) {
        searchResultsDiv.style.display = "none";
        return;
      }

      const searchURL = `http://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(query)}`;
      const res = await fetch(searchURL);
      const data = await res.json();

      if (data.Search && data.Search.length > 0) {
        searchResultsDiv.style.display = "block";
        const limitedResults = data.Search.slice(0, 8); // Limit to 8 suggestions
        limitedResults.forEach(movie => {
          const div = document.createElement("div");
          div.className = "search-result-item";
          div.innerHTML = `
            <img src="${movie.Poster !== "N/A" ? movie.Poster : ''}" alt="${movie.Title}">
            <div class="info">
              <div class="title">${movie.Title}</div>
              <div class="year">${movie.Year}</div>
            </div>
          `;
          div.onclick = () => {
            loadDetails(movie.imdbID);
            searchResultsDiv.style.display = "none";
            document.getElementById("searchInput").value = movie.Title;
          };
          searchResultsDiv.appendChild(div);
        });
      } else {
        searchResultsDiv.style.display = "none";
      }
    }

    // Debounced suggestions
    const debouncedFetchSuggestions = debounce(fetchSuggestions, 300);

    // Search movies
    async function searchMovie() {
      const query = document.getElementById("searchInput").value.trim();
      const searchResultsDiv = document.getElementById("searchResults");
      searchResultsDiv.innerHTML = "";

      if (!query) return alert("Enter a movie name or IMDb ID!");

      // Check if query is an IMDb ID (e.g., tt0111161)
      const imdbRegex = /^tt\d{7,9}$/;
      if (imdbRegex.test(query)) {
        loadDetails(query);
        searchResultsDiv.style.display = "none";
        return;
      }

      const searchURL = `http://www.omdbapi.com/?apikey=${OMDB_KEY}&s=${encodeURIComponent(query)}`;
      const res = await fetch(searchURL);
      const data = await res.json();

      if (data.Search && data.Search.length > 0) {
        // Show search results list
        searchResultsDiv.style.display = "block";
        data.Search.forEach(movie => {
          const div = document.createElement("div");
          div.className = "search-result-item";
          div.innerHTML = `
            <img src="${movie.Poster !== "N/A" ? movie.Poster : ''}" alt="${movie.Title}">
            <div class="info">
              <div class="title">${movie.Title}</div>
              <div class="year">${movie.Year}</div>
            </div>
          `;
          div.onclick = () => {
            loadDetails(movie.imdbID);
            searchResultsDiv.style.display = "none";
          };
          searchResultsDiv.appendChild(div);
        });
      } else {
        searchResultsDiv.style.display = "none";
        alert("No results found!");
      }
    }

    // Event listeners
    document.getElementById("searchInput").addEventListener("input", (e) => {
      debouncedFetchSuggestions(e.target.value);
    });

    // Auto-update video when provider changes
    document.getElementById("providerSelect").addEventListener("change", () => {
      if (currentImdb) {
        playContent(currentImdb);
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener("click", (e) => {
      const searchResultsDiv = document.getElementById("searchResults");
      const searchBox = document.querySelector(".search-box");
      if (!searchBox.contains(e.target)) {
        searchResultsDiv.style.display = "none";
      }
    });


  </script>
</body>
</html>
